FROM node:12


#Install flutter dependencies
RUN apt-get update
RUN apt-get install -y curl git wget zip unzip libgconf-2-4 gdb libstdc++6 libglu1-mesa fonts-droid-fallback lib32stdc++6 python3
RUN apt-get clean

# Clone the flutter repo
RUN git clone https://github.com/flutter/flutter.git /usr/local/flutter

# Run flutter doctor and set path
RUN /usr/local/flutter/bin/flutter doctor -v

# Enable flutter web
RUN /usr/local/flutter/bin/flutter channel beta
RUN /usr/local/flutter/bin/flutter upgrade
RUN /usr/local/flutter/bin/flutter config --enable-web

# Copy files to container and build
RUN mkdir /home/node/flutter
COPY . /home/node/flutter
WORKDIR /home/node/flutter
RUN /usr/local/flutter/bin/flutter build web


# Create app directory
RUN mkdir /home/node/app
WORKDIR /home/node/app
RUN ls
RUN ls /home/node/flutter/node/

# Install app dependencies
# A wildcard is used to ensure both package.json AND package-lock.json are copied
# where available (npm@5+)
COPY  ./home/node/flutter/node/* ./

RUN npm install
RUN npm install express --save
# If you are building your code for production
# RUN npm ci --only=production

# Bundle app source
COPY ./home/node/flutter/build/web/* ./

EXPOSE 3000

CMD [ "node", "app.js" ]